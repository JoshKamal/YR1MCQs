<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medical MCQ Quiz Application</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #3b82f6;
      --secondary-color: #4338ca;
      --success-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #06b6d4;
      --body-bg: #f3f4f6;
      --card-bg: #ffffff;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--body-bg);
      padding-bottom: 2rem;
    }

    .navbar {
      background-color: var(--primary-color);
    }

    .badge {
      font-weight: normal;
      padding: 0.35em 0.65em;
      border-radius: 0.375rem;
    }

    .quiz-card {
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      background-color: var(--card-bg);
      margin-bottom: 1.5rem;
    }

    .quiz-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .quiz-option {
      padding: 0.75rem 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quiz-option:hover {
      background-color: #f9fafb;
    }

    .quiz-option.selected {
      background-color: #e0e7ff;
      border-color: var(--primary-color);
    }

    .quiz-option.correct {
      background-color: #d1fae5;
      border-color: var(--success-color);
    }

    .quiz-option.incorrect {
      background-color: #fee2e2;
      border-color: var(--danger-color);
    }

    .explanation-box {
      background-color: #f8fafc;
      border-left: 4px solid var(--info-color);
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.375rem;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    .btn-success {
      background-color: var(--success-color);
      border-color: var(--success-color);
    }

    .btn-danger {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
    }

    .progress {
      height: 0.5rem;
      border-radius: 1rem;
    }

    .topic-card {
      border-radius: 0.5rem;
      border: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      transition: all 0.3s cubic-bezier(.25,.8,.25,1);
      margin-bottom: 1.5rem;
    }

    .topic-card:hover {
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
    }

    .topic-card .card-header {
      background-color: var(--primary-color);
      color: white;
      border-radius: 0.5rem 0.5rem 0 0;
      font-weight: bold;
    }

    .chart-container {
      position: relative;
      height: 250px;
    }

    .nav-tabs .nav-link {
      color: #6b7280;
      border: none;
    }

    .nav-tabs .nav-link.active {
      font-weight: bold;
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      background-color: transparent;
    }

    @media (max-width: 768px) {
      .card {
        margin-bottom: 1rem;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-clipboard2-pulse me-2"></i>Medical MCQ Quiz
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="#" id="dashboard-link">
              <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="practice-link">
              <i class="bi bi-journal-check me-1"></i>Practice
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="modules-link">
              <i class="bi bi-grid-3x3-gap me-1"></i>Modules
            </a>
          </li>
        </ul>
        <div class="dropdown">
          <button class="btn btn-light dropdown-toggle" type="button" id="moduleSelector" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-grid-3x3-gap-fill me-1"></i>Select Module
          </button>
          <ul class="dropdown-menu" aria-labelledby="moduleSelector">
            <li><a class="dropdown-item" href="#" data-module="all">All Questions</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" data-module="focs">FOCS</a></li>
            <li><a class="dropdown-item" href="#" data-module="bcr">BCR</a></li>
            <li><a class="dropdown-item" href="#" data-module="msk">MSK</a></li>
            <li><a class="dropdown-item" href="#" data-module="anatomy">Anatomy</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container" id="app-container">
    <!-- Dashboard View -->
    <div id="dashboard-view" class="view">
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-bar-chart-line me-2"></i>Overall Performance</h5>
              <div class="d-flex justify-content-between mb-3">
                <div>
                  <h6 class="text-muted mb-1">Attempted</h6>
                  <h3 id="total-attempted">0</h3>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Correct</h6>
                  <h3 id="total-correct">0</h3>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Accuracy</h6>
                  <h3 id="overall-accuracy">0%</h3>
                </div>
              </div>
              <div>
                <h6 class="mb-2">Accuracy Rate</h6>
                <div class="progress mb-2">
                  <div id="accuracy-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
              <div id="recent-activity" class="mt-3">
                <p class="text-center text-muted">No recent activity</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-12">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-bullseye me-2"></i>Topics to Focus On</h5>
              <div id="focus-topics-container" class="mt-3">
                <p class="text-center text-muted">Complete more questions to get recommendations</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-book me-2"></i>Topic Analysis</h5>
              <div id="topics-analysis" class="mt-3 row">
                <p class="text-center text-muted">Complete more questions to see topic analysis</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="d-flex justify-content-end">
            <button id="export-data" class="btn btn-outline-primary me-2">
              <i class="bi bi-download me-1"></i>Export Data
            </button>
            <button id="reset-data" class="btn btn-outline-danger">
              <i class="bi bi-trash me-1"></i>Reset Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Practice View -->
    <div id="practice-view" class="view d-none">
      <div class="card quiz-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <span id="current-module-badge" class="badge bg-primary mb-1">All Questions</span>
              <h5 id="question-counter" class="mb-0">Question 1 of 20</h5>
            </div>
            <div>
              <button id="skip-question" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-skip-forward me-1"></i>Skip
              </button>
            </div>
          </div>

          <div class="progress mb-3">
            <div id="question-progress" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
          </div>

          <h4 id="question-text" class="mb-3">Loading question...</h4>
          
          <div id="options-container" class="mb-3">
            <!-- Options will be inserted here -->
          </div>

          <div id="explanation-container" class="explanation-box d-none">
            <h6 class="mb-2">Explanation:</h6>
            <div id="explanation-text"></div>
            <div class="mt-2">
              <small class="text-muted">Source: <span id="slide-link"></span></small>
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-between">
          <button id="prev-question" class="btn btn-outline-primary" disabled>
            <i class="bi bi-arrow-left me-1"></i>Previous
          </button>
          <button id="next-question" class="btn btn-primary" disabled>
            Next<i class="bi bi-arrow-right ms-1"></i>
          </button>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-graph-up me-2"></i>Current Session</h5>
              <div class="d-flex justify-content-between mt-3">
                <div>
                  <h6 class="text-muted mb-1">Attempted</h6>
                  <h3 id="session-attempted">0</h3>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Correct</h6>
                  <h3 id="session-correct">0</h3>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Accuracy</h6>
                  <h3 id="session-accuracy">0%</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-info-circle me-2"></i>Current Topic</h5>
              <div class="mt-3">
                <h6 class="text-muted mb-1">Topic</h6>
                <h4 id="current-topic">-</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modules View -->
    <div id="topic-focus-view" class="view d-none">
      <div class="row">
        <div class="col-12 mb-4">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-grid-3x3-gap me-2"></i>Select Module & Start Practice</h5>
              <div class="row g-3 mt-1">
                <div class="col-md-6">
                  <label for="topic-filter" class="form-label">Module</label>
                  <select id="topic-filter" class="form-select">
                    <option value="all">All Modules</option>
                    <!-- Topics will be populated here -->
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="status-filter" class="form-label">Status</label>
                  <select id="status-filter" class="form-select">
                    <option value="all">All Questions</option>
                    <option value="attempted">Attempted</option>
                    <option value="correct">Correct</option>
                    <option value="incorrect">Incorrect</option>
                    <option value="unattempted">Unattempted</option>
                  </select>
                </div>
                <div class="col-12">
                  <button id="start-focused-practice" class="btn btn-primary mt-2">
                    <i class="bi bi-play-fill me-1"></i>Start Practice
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row" id="topic-stats-container">
        <!-- Topic statistics will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalTitle">Confirmation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">
          Are you sure you want to proceed?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmModalAction">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // Initialize with empty arrays for questions until they're loaded
    const allQuestions = [];
    const focsQuestions = [];
    const bcrQuestions = [];
    const mskQuestions = [];
    const anatomyQuestions = [];
    
    // App State
    let questions = [];
    let currentQuestionIndex = 0;
    let selectedAnswer = null;
    let answerSubmitted = false;
    let userHistory = [];
    let currentSessionStats = {
      attempted: 0,
      correct: 0
    };
    let currentView = 'dashboard';
    let currentModule = 'all';
    let moduleQuestions = {
      all: allQuestions,
      focs: focsQuestions,
      bcr: bcrQuestions,
      msk: mskQuestions,
      anatomy: anatomyQuestions
    };
    
    // Load questions from server
    async function loadQuestions() {
      try {
        // For now we'll use sample data
        // These can be replaced with server-loaded questions later
        // Add some sample questions to each module
        addSampleQuestions();
        
        // Initialize app after loading questions
        questions = [...allQuestions];
        moduleQuestions.all = allQuestions;
        moduleQuestions.focs = focsQuestions;
        moduleQuestions.bcr = bcrQuestions;
        moduleQuestions.msk = mskQuestions;
        moduleQuestions.anatomy = anatomyQuestions;
        
        // Initialize the app
        init();
      } catch (error) {
        console.error('Error loading questions:', error);
      }
    }
    
    // Add some sample questions for testing
    function addSampleQuestions() {
      // Sample FOCS question
      focsQuestions.push({
        question: "Which enzyme family is primarily responsible for Phase I metabolism in the liver?",
        options: [
          "A) Acetyltransferases",
          "B) Glucuronosyltransferases",
          "C) Cytochrome P450 enzymes",
          "D) Monoamine oxidases",
          "E) Peptidases"
        ],
        correctIndex: 2,
        explanations: [
          "Incorrect: Acetyltransferases are involved in Phase II reactions.",
          "Incorrect: Glucuronosyltransferases are Phase II enzymes.",
          "Correct: Cytochrome P450 enzymes mediate oxidation, reduction, and hydrolysis in Phase I metabolism.",
          "Incorrect: Monoamine oxidases break down neurotransmitters, not general drug metabolism.",
          "Incorrect: Peptidases degrade peptides but are not key in Phase I metabolism."
        ],
        slideLink: "Pharmacokinetics part1",
        topic: "Pharmacology"
      });
      
      // Sample BCR question
      bcrQuestions.push({
        question: "Which heart sound is associated with mitral stenosis?",
        options: [
          "A) Split S1",
          "B) Opening snap",
          "C) Midsystolic click",
          "D) Summation gallop",
          "E) Pericardial knock"
        ],
        correctIndex: 1,
        explanations: [
          "Incorrect: Split S1 can occur in bundle branch blocks but is not typical of mitral stenosis.",
          "Correct: The opening snap is a high-pitched early diastolic sound heard after S2 in mitral stenosis.",
          "Incorrect: Midsystolic click is associated with mitral valve prolapse, not stenosis.",
          "Incorrect: Summation gallop occurs with tachycardia when S3 and S4 merge.",
          "Incorrect: Pericardial knock is heard in constrictive pericarditis."
        ],
        slideLink: "Cardiovascular Examination, slide 31",
        topic: "Cardiovascular Examination"
      });
      
      // Sample MSK question
      mskQuestions.push({
        question: "What is the primary cellular defect in Duchenne muscular dystrophy?",
        options: [
          "A) Deficiency of dystrophin protein",
          "B) Abnormal myosin heavy chain",
          "C) Defective acetylcholine receptors",
          "D) Mitochondrial DNA mutations",
          "E) Abnormal calcium channel function"
        ],
        correctIndex: 0,
        explanations: [
          "Correct: Duchenne muscular dystrophy is caused by mutations in the DMD gene leading to absence of functional dystrophin protein.",
          "Incorrect: Myosin abnormalities are associated with some congenital myopathies, not DMD.",
          "Incorrect: Acetylcholine receptor defects cause myasthenia gravis, not muscular dystrophy.",
          "Incorrect: Mitochondrial DNA mutations cause mitochondrial myopathies, not DMD.",
          "Incorrect: Calcium channel dysfunction is associated with periodic paralyses, not DMD."
        ],
        slideLink: "Neuromuscular Disorders, Slide 7",
        topic: "Neuromuscular Disorders"
      });
      
      // Sample Anatomy question
      anatomyQuestions.push({
        question: "Which of the following structures passes through the carpal tunnel?",
        options: [
          "A) Ulnar nerve",
          "B) Ulnar artery",
          "C) Radial artery",
          "D) Median nerve",
          "E) Superficial palmar arch"
        ],
        correctIndex: 3,
        explanations: [
          "Incorrect: The ulnar nerve passes through Guyon's canal, not the carpal tunnel.",
          "Incorrect: The ulnar artery passes superficial to the flexor retinaculum in Guyon's canal.",
          "Incorrect: The radial artery is located at the lateral aspect of the wrist, not in the carpal tunnel.",
          "Correct: The median nerve passes through the carpal tunnel with the flexor tendons.",
          "Incorrect: The superficial palmar arch is located in the palm, distal to the carpal tunnel."
        ],
        slideLink: "Upper Limb Anatomy Lecture 4",
        topic: "Upper Limb Anatomy"
      });
      
      // Add to all questions
      allQuestions.push(...focsQuestions, ...bcrQuestions, ...mskQuestions, ...anatomyQuestions);
    }

    // DOM Elements
    const dashboardLink = document.getElementById('dashboard-link');
    const practiceLink = document.getElementById('practice-link');
    const modulesLink = document.getElementById('modules-link');
    const dashboardView = document.getElementById('dashboard-view');
    const practiceView = document.getElementById('practice-view');
    const topicFocusView = document.getElementById('topic-focus-view');
    const questionCounter = document.getElementById('question-counter');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const explanationContainer = document.getElementById('explanation-container');
    const explanationText = document.getElementById('explanation-text');
    const slideLink = document.getElementById('slide-link');
    const prevQuestion = document.getElementById('prev-question');
    const nextQuestion = document.getElementById('next-question');
    const skipQuestion = document.getElementById('skip-question');
    const questionProgress = document.getElementById('question-progress');
    const sessionAttempted = document.getElementById('session-attempted');
    const sessionCorrect = document.getElementById('session-correct');
    const sessionAccuracy = document.getElementById('session-accuracy');
    const currentTopic = document.getElementById('current-topic');
    const currentModuleBadge = document.getElementById('current-module-badge');
    const totalAttempted = document.getElementById('total-attempted');
    const totalCorrect = document.getElementById('total-correct');
    const overallAccuracy = document.getElementById('overall-accuracy');
    const accuracyProgress = document.getElementById('accuracy-progress');
    const recentActivity = document.getElementById('recent-activity');
    const focusTopicsContainer = document.getElementById('focus-topics-container');
    const topicsAnalysis = document.getElementById('topics-analysis');
    const exportData = document.getElementById('export-data');
    const resetData = document.getElementById('reset-data');
    const topicFilter = document.getElementById('topic-filter');
    const statusFilter = document.getElementById('status-filter');
    const startFocusedPractice = document.getElementById('start-focused-practice');
    const topicStatsContainer = document.getElementById('topic-stats-container');
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const confirmModalTitle = document.getElementById('confirmModalTitle');
    const confirmModalBody = document.getElementById('confirmModalBody');
    const confirmModalAction = document.getElementById('confirmModalAction');
    
    // Initialize app
    function init() {
      // Load user history from local storage
      loadUserHistory();
      
      // Set up event listeners
      setupEventListeners();
      
      // Shuffle and load questions
      shuffleQuestions();
      loadQuestion();
      
      // Update dashboard stats
      updateDashboardStats();
      updateTopicFilters();
      
      // Set up module selection
      setupModuleSelection();
    }
    
    // Load user history from local storage
    function loadUserHistory() {
      const savedHistory = localStorage.getItem('userHistory');
      if (savedHistory) {
        userHistory = JSON.parse(savedHistory);
      }
    }
    
    // Save user history to local storage
    function saveUserHistory() {
      localStorage.setItem('userHistory', JSON.stringify(userHistory));
    }
    
    // Shuffle questions array
    function shuffleQuestions() {
      questions = [...moduleQuestions[currentModule]];
      for (let i = questions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [questions[i], questions[j]] = [questions[j], questions[i]];
      }
      currentQuestionIndex = 0;
    }
    
    // Load current question
    function loadQuestion() {
      if (questions.length === 0) {
        questionText.textContent = "No questions available.";
        optionsContainer.innerHTML = "";
        return;
      }
      
      const question = questions[currentQuestionIndex];
      questionText.textContent = question.question;
      questionCounter.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
      currentTopic.textContent = question.topic;
      
      // Update progress bar
      const progressPercent = ((currentQuestionIndex + 1) / questions.length) * 100;
      questionProgress.style.width = `${progressPercent}%`;
      
      // Clear previous options and explanation
      optionsContainer.innerHTML = "";
      explanationContainer.classList.add('d-none');
      
      // Populate options
      question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'quiz-option';
        optionDiv.textContent = option;
        optionDiv.dataset.index = index;
        
        // Check if this question has been answered in this session
        const historyItem = findQuestionInHistory(currentQuestionIndex);
        if (historyItem) {
          if (historyItem.selectedAnswer === index) {
            optionDiv.classList.add('selected');
            if (index === question.correctIndex) {
              optionDiv.classList.add('correct');
            } else {
              optionDiv.classList.add('incorrect');
            }
          } else if (index === question.correctIndex) {
            optionDiv.classList.add('correct');
          }
          answerSubmitted = true;
          explanationContainer.classList.remove('d-none');
          populateExplanation(question);
        } else {
          answerSubmitted = false;
          optionDiv.addEventListener('click', () => selectOption(index));
        }
        
        optionsContainer.appendChild(optionDiv);
      });
      
      // Update navigation buttons
      prevQuestion.disabled = currentQuestionIndex === 0;
      nextQuestion.disabled = !answerSubmitted;
    }
    
    // Select an option
    function selectOption(index) {
      if (answerSubmitted) return;
      
      selectedAnswer = index;
      const question = questions[currentQuestionIndex];
      
      // Mark the selected option
      const options = optionsContainer.querySelectorAll('.quiz-option');
      options.forEach(option => {
        const optionIndex = parseInt(option.dataset.index);
        option.classList.remove('selected', 'correct', 'incorrect');
        
        if (optionIndex === selectedAnswer) {
          option.classList.add('selected');
          if (optionIndex === question.correctIndex) {
            option.classList.add('correct');
          } else {
            option.classList.add('incorrect');
          }
        } else if (optionIndex === question.correctIndex) {
          option.classList.add('correct');
        }
      });
      
      // Show explanation
      explanationContainer.classList.remove('d-none');
      populateExplanation(question);
      
      // Record answer
      const isCorrect = selectedAnswer === question.correctIndex;
      recordAnswer(currentQuestionIndex, selectedAnswer, isCorrect);
      
      // Update stats
      currentSessionStats.attempted++;
      if (isCorrect) currentSessionStats.correct++;
      updateSessionStats();
      
      // Enable next button
      nextQuestion.disabled = false;
      answerSubmitted = true;
    }
    
    // Populate explanation
    function populateExplanation(question) {
      explanationText.innerHTML = '';
      question.explanations.forEach((exp, index) => {
        const expPara = document.createElement('p');
        expPara.className = 'mb-1';
        if (exp.includes('Correct:')) {
          expPara.className += ' text-success fw-bold';
        }
        expPara.textContent = exp;
        explanationText.appendChild(expPara);
      });
      
      slideLink.textContent = question.slideLink;
    }
    
    // Record answer in history
    function recordAnswer(questionIndex, selectedAnswer, isCorrect) {
      const historyItem = {
        questionIndex: questionIndex,
        selectedAnswer: selectedAnswer,
        isCorrect: isCorrect,
        timestamp: new Date().toISOString()
      };
      
      // Check if this question has already been answered in this session
      const existingIndex = userHistory.findIndex(item => 
        item.questionIndex === questionIndex && 
        questions[item.questionIndex].question === questions[questionIndex].question
      );
      
      if (existingIndex !== -1) {
        userHistory[existingIndex] = historyItem;
      } else {
        userHistory.push(historyItem);
      }
      
      saveUserHistory();
      updateDashboardStats();
    }
    
    // Find a question in history
    function findQuestionInHistory(questionIndex) {
      return userHistory.find(item => 
        item.questionIndex === questionIndex && 
        questions[item.questionIndex].question === questions[questionIndex].question
      );
    }
    
    // Update session statistics
    function updateSessionStats() {
      sessionAttempted.textContent = currentSessionStats.attempted;
      sessionCorrect.textContent = currentSessionStats.correct;
      
      const accuracy = currentSessionStats.attempted ? 
        Math.round((currentSessionStats.correct / currentSessionStats.attempted) * 100) : 0;
      sessionAccuracy.textContent = `${accuracy}%`;
    }
    
    // Update dashboard statistics
    function updateDashboardStats() {
      // Update overall stats
      const attemptedCount = userHistory.length;
      const correctCount = userHistory.filter(item => item.isCorrect).length;
      const accuracyRate = attemptedCount ? Math.round((correctCount / attemptedCount) * 100) : 0;
      
      totalAttempted.textContent = attemptedCount;
      totalCorrect.textContent = correctCount;
      overallAccuracy.textContent = `${accuracyRate}%`;
      accuracyProgress.style.width = `${accuracyRate}%`;
      
      // Update recent activity
      updateRecentActivity();
      
      // Update focus topics
      updateFocusTopics();
      
      // Update topics analysis
      updateTopicsAnalysis();
      
      // Update topic stats in the focus view
      updateTopicStats();
    }
    
    // Update recent activity
    function updateRecentActivity() {
      const recentItems = [...userHistory]
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 5);
      
      if (recentItems.length === 0) {
        recentActivity.innerHTML = '<p class="text-center text-muted">No recent activity</p>';
        return;
      }
      
      const activityList = document.createElement('ul');
      activityList.className = 'list-group';
      
      recentItems.forEach(item => {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        
        const questionText = questions.find(q => q.question === questions[item.questionIndex].question)?.question;
        const truncatedQuestion = questionText ? 
          (questionText.length > 70 ? questionText.substring(0, 70) + '...' : questionText) : 
          'Unknown question';
        
        const date = new Date(item.timestamp);
        const timeStr = date.toLocaleString();
        
        listItem.innerHTML = `
          <div>
            <small class="text-muted">${timeStr}</small>
            <div>${truncatedQuestion}</div>
          </div>
          <span class="badge ${item.isCorrect ? 'bg-success' : 'bg-danger'} rounded-pill ms-2">
            ${item.isCorrect ? 'Correct' : 'Incorrect'}
          </span>
        `;
        
        activityList.appendChild(listItem);
      });
      
      recentActivity.innerHTML = '';
      recentActivity.appendChild(activityList);
    }
    
    // Update focus topics
    function updateFocusTopics() {
      if (userHistory.length < 5) {
        focusTopicsContainer.innerHTML = '<p class="text-center text-muted">Complete more questions to get recommendations</p>';
        return;
      }
      
      // Get topic stats
      const topicStats = {};
      userHistory.forEach(item => {
        const question = questions.find(q => q.question === questions[item.questionIndex].question);
        if (!question) return;
        
        const topic = question.topic;
        if (!topicStats[topic]) {
          topicStats[topic] = { attempted: 0, correct: 0 };
        }
        
        topicStats[topic].attempted++;
        if (item.isCorrect) {
          topicStats[topic].correct++;
        }
      });
      
      // Calculate accuracy for each topic
      for (const topic in topicStats) {
        const stats = topicStats[topic];
        stats.accuracy = stats.attempted ? (stats.correct / stats.attempted) * 100 : 0;
      }
      
      // Sort topics by accuracy (ascending) and get the bottom 3
      const focusTopics = Object.entries(topicStats)
        .filter(([_, stats]) => stats.attempted >= 2) // At least 2 attempts
        .sort(([_, statsA], [__, statsB]) => statsA.accuracy - statsB.accuracy)
        .slice(0, 3);
      
      if (focusTopics.length === 0) {
        focusTopicsContainer.innerHTML = '<p class="text-center text-muted">Complete more questions in each topic to get recommendations</p>';
        return;
      }
      
      const focusList = document.createElement('div');
      focusList.className = 'row';
      
      focusTopics.forEach(([topic, stats]) => {
        const accuracy = Math.round(stats.accuracy);
        let reason, backgroundColor;
        
        if (accuracy < 40) {
          reason = 'Major improvement needed';
          backgroundColor = '#fee2e2'; // Light red
        } else if (accuracy < 70) {
          reason = 'Needs more practice';
          backgroundColor = '#fef3c7'; // Light yellow
        } else {
          reason = 'Good but can improve';
          backgroundColor = '#d1fae5'; // Light green
        }
        
        const topicCol = document.createElement('div');
        topicCol.className = 'col-md-4 mb-3';
        topicCol.innerHTML = `
          <div class="card h-100" style="background-color: ${backgroundColor};">
            <div class="card-body">
              <h5 class="card-title">${topic}</h5>
              <div class="d-flex justify-content-between mb-2">
                <div>
                  <small class="text-muted">Accuracy</small>
                  <div class="h4">${accuracy}%</div>
                </div>
                <div>
                  <small class="text-muted">Attempted</small>
                  <div class="h4">${stats.attempted}</div>
                </div>
              </div>
              <p class="card-text"><small>${reason}</small></p>
              <button class="btn btn-sm btn-primary focus-topic-btn" data-topic="${topic}">
                Practice Now
              </button>
            </div>
          </div>
        `;
        
        focusList.appendChild(topicCol);
      });
      
      focusTopicsContainer.innerHTML = '';
      focusTopicsContainer.appendChild(focusList);
      
      // Add event listeners to focus topic buttons
      document.querySelectorAll('.focus-topic-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const topic = btn.dataset.topic;
          topicFilter.value = topic;
          statusFilter.value = 'all';
          switchView('topic-focus');
        });
      });
    }
    
    // Update topics analysis
    function updateTopicsAnalysis() {
      // Get all unique topics
      const allTopics = [...new Set(questions.map(q => q.topic))];
      
      if (userHistory.length === 0) {
        topicsAnalysis.innerHTML = '<p class="text-center text-muted">Complete more questions to see topic analysis</p>';
        return;
      }
      
      // Get detailed stats for each topic
      const topicAnalysis = allTopics.map(topic => {
        const topicQuestions = questions.filter(q => q.topic === topic);
        const attemptedHistory = userHistory.filter(item => {
          const question = questions.find(q => q.question === questions[item.questionIndex].question);
          return question && question.topic === topic;
        });
        
        const attempted = attemptedHistory.length;
        const correct = attemptedHistory.filter(item => item.isCorrect).length;
        const accuracy = attempted ? (correct / attempted) * 100 : 0;
        
        // Extract key concepts (simplified)
        const keyConcepts = topicQuestions
          .map(q => q.question.split(' ').slice(0, 3).join(' ') + '...')
          .slice(0, 3);
        
        return {
          name: topic,
          attempted,
          correct,
          accuracy,
          keyConcepts
        };
      }).filter(topic => topic.attempted > 0);
      
      if (topicAnalysis.length === 0) {
        topicsAnalysis.innerHTML = '<p class="text-center text-muted">Complete more questions to see topic analysis</p>';
        return;
      }
      
      // Sort by most attempted
      topicAnalysis.sort((a, b) => b.attempted - a.attempted);
      
      const analysisCards = document.createElement('div');
      analysisCards.className = 'row';
      
      topicAnalysis.forEach(topic => {
        const accuracyRounded = Math.round(topic.accuracy);
        let textColor = 'text-danger';
        
        if (accuracyRounded >= 70) {
          textColor = 'text-success';
        } else if (accuracyRounded >= 40) {
          textColor = 'text-warning';
        }
        
        const topicCard = document.createElement('div');
        topicCard.className = 'col-md-4 mb-3';
        topicCard.innerHTML = `
          <div class="card topic-card h-100">
            <div class="card-header">
              ${topic.name}
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between mb-3">
                <div>
                  <small class="text-muted">Attempted</small>
                  <div class="h4">${topic.attempted}</div>
                </div>
                <div>
                  <small class="text-muted">Correct</small>
                  <div class="h4">${topic.correct}</div>
                </div>
                <div>
                  <small class="text-muted">Accuracy</small>
                  <div class="h4 ${textColor}">${accuracyRounded}%</div>
                </div>
              </div>
              
              <h6 class="card-subtitle mb-2 text-muted">Key Concepts:</h6>
              <ul class="list-group list-group-flush">
                ${topic.keyConcepts.map(concept => `
                  <li class="list-group-item py-1">${concept}</li>
                `).join('')}
              </ul>
            </div>
          </div>
        `;
        
        analysisCards.appendChild(topicCard);
      });
      
      topicsAnalysis.innerHTML = '';
      topicsAnalysis.appendChild(analysisCards);
    }
    
    // Update topic filters
    function updateTopicFilters() {
      // Get all unique topics
      const allTopics = [...new Set(questions.map(q => q.topic))];
      
      // Clear existing options (keeping the 'All Topics' option)
      while (topicFilter.options.length > 1) {
        topicFilter.remove(1);
      }
      
      // Add new options
      allTopics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic;
        option.textContent = topic;
        topicFilter.appendChild(option);
      });
    }
    
    // Update topic stats
    function updateTopicStats() {
      // Get topic filter value
      const selectedTopic = topicFilter.value;
      const selectedStatus = statusFilter.value;
      
      // Get all unique topics
      const allTopics = [...new Set(questions.map(q => q.topic))];
      const filteredTopics = selectedTopic === 'all' ? allTopics : [selectedTopic];
      
      const topicStats = filteredTopics.map(topic => {
        const topicQuestions = questions.filter(q => q.topic === topic);
        const attemptedHistory = userHistory.filter(item => {
          const question = questions.find(q => q.question === questions[item.questionIndex].question);
          return question && question.topic === topic;
        });
        
        const attempted = attemptedHistory.length;
        const correct = attemptedHistory.filter(item => item.isCorrect).length;
        const accuracy = attempted ? (correct / attempted) * 100 : 0;
        
        return {
          name: topic,
          totalQuestions: topicQuestions.length,
          attempted,
          correct,
          incorrect: attempted - correct,
          accuracy
        };
      });
      
      // Display stats
      topicStatsContainer.innerHTML = '';
      
      topicStats.forEach(stat => {
        const accuracyRounded = Math.round(stat.accuracy);
        let progressColor = 'bg-danger';
        
        if (accuracyRounded >= 70) {
          progressColor = 'bg-success';
        } else if (accuracyRounded >= 40) {
          progressColor = 'bg-warning';
        }
        
        const statCard = document.createElement('div');
        statCard.className = 'col-md-6 mb-4';
        statCard.innerHTML = `
          <div class="card topic-card">
            <div class="card-header">
              ${stat.name}
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-4 text-center">
                  <h6 class="text-muted mb-1">Total</h6>
                  <h3>${stat.totalQuestions}</h3>
                </div>
                <div class="col-4 text-center">
                  <h6 class="text-muted mb-1">Attempted</h6>
                  <h3>${stat.attempted}</h3>
                </div>
                <div class="col-4 text-center">
                  <h6 class="text-muted mb-1">Accuracy</h6>
                  <h3>${accuracyRounded}%</h3>
                </div>
              </div>
              
              <div class="mb-3">
                <h6>Progress</h6>
                <div class="progress mb-2">
                  <div class="progress-bar ${progressColor}" role="progressbar" 
                       style="width: ${(stat.attempted / stat.totalQuestions) * 100}%"></div>
                </div>
                <small class="text-muted">${stat.attempted} of ${stat.totalQuestions} questions attempted</small>
              </div>
              
              <div class="d-flex">
                <div class="me-3">
                  <span class="badge bg-success">${stat.correct} Correct</span>
                </div>
                <div>
                  <span class="badge bg-danger">${stat.incorrect} Incorrect</span>
                </div>
              </div>
            </div>
          </div>
        `;
        
        topicStatsContainer.appendChild(statCard);
      });
    }
    
    // Set up module selection
    function setupModuleSelection() {
      document.querySelectorAll('.dropdown-menu a[data-module]').forEach(item => {
        item.addEventListener('click', event => {
          event.preventDefault();
          const module = event.target.dataset.module;
          currentModule = module;
          document.getElementById('moduleSelector').textContent = 
            module === 'all' ? 'All Questions' : module.toUpperCase();
          
          // Update badge
          currentModuleBadge.textContent = module === 'all' ? 'All Questions' : module.toUpperCase();
          
          // Reset and load questions from the selected module
          questions = [...moduleQuestions[module]];
          shuffleQuestions();
          loadQuestion();
          
          // Reset session stats
          currentSessionStats = {
            attempted: 0,
            correct: 0
          };
          updateSessionStats();
        });
      });
    }
    
    // Start focused practice
    startFocusedPractice.addEventListener('click', () => {
      const selectedTopic = topicFilter.value;
      const selectedStatus = statusFilter.value;
      
      // Filter questions based on topic
      let filteredQuestions = questions;
      if (selectedTopic !== 'all') {
        filteredQuestions = questions.filter(q => q.topic === selectedTopic);
      }
      
      // Filter questions based on status
      if (selectedStatus !== 'all') {
        filteredQuestions = filteredQuestions.filter(q => {
          const historyItem = userHistory.find(item => {
            return questions[item.questionIndex].question === q.question;
          });
          
          switch (selectedStatus) {
            case 'attempted':
              return historyItem !== undefined;
            case 'correct':
              return historyItem && historyItem.isCorrect;
            case 'incorrect':
              return historyItem && !historyItem.isCorrect;
            case 'unattempted':
              return historyItem === undefined;
            default:
              return true;
          }
        });
      }
      
      if (filteredQuestions.length === 0) {
        alert('No questions match your filter criteria. Please try different filters.');
        return;
      }
      
      // Update questions and start practice
      questions = filteredQuestions;
      shuffleQuestions();
      loadQuestion();
      
      // Reset session stats
      currentSessionStats = {
        attempted: 0,
        correct: 0
      };
      updateSessionStats();
      
      // Switch to practice view
      switchView('practice');
    });
    
    // Set up event listeners
    function setupEventListeners() {
      // Navigation links
      dashboardLink.addEventListener('click', () => switchView('dashboard'));
      practiceLink.addEventListener('click', () => switchView('practice'));
      modulesLink.addEventListener('click', () => switchView('topic-focus'));
      
      // Question navigation
      prevQuestion.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          loadQuestion();
        }
      });
      
      nextQuestion.addEventListener('click', () => {
        if (currentQuestionIndex < questions.length - 1) {
          currentQuestionIndex++;
          loadQuestion();
          nextQuestion.disabled = true;
        }
      });
      
      skipQuestion.addEventListener('click', () => {
        if (currentQuestionIndex < questions.length - 1) {
          currentQuestionIndex++;
          loadQuestion();
        }
      });
      
      // Export data
      exportData.addEventListener('click', () => {
        const dataStr = JSON.stringify({
          userHistory,
          timestamp: new Date().toISOString(),
          stats: {
            totalAttempted: userHistory.length,
            totalCorrect: userHistory.filter(item => item.isCorrect).length
          }
        });
        
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = 'quiz_data.json';
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
      });
      
      // Reset data
      resetData.addEventListener('click', () => {
        confirmModalTitle.textContent = 'Reset Data';
        confirmModalBody.textContent = 'Are you sure you want to reset all your quiz data? This action cannot be undone.';
        
        confirmModalAction.onclick = () => {
          userHistory = [];
          saveUserHistory();
          updateDashboardStats();
          
          currentSessionStats = {
            attempted: 0,
            correct: 0
          };
          updateSessionStats();
          
          confirmModal.hide();
        };
        
        confirmModal.show();
      });
      
      // Filters change handler
      topicFilter.addEventListener('change', updateTopicStats);
      statusFilter.addEventListener('change', updateTopicStats);
    }
    
    // Switch between views
    function switchView(view) {
      currentView = view;
      
      // Update navigation links
      dashboardLink.classList.toggle('active', view === 'dashboard');
      practiceLink.classList.toggle('active', view === 'practice');
      modulesLink.classList.toggle('active', view === 'topic-focus');
      
      // Show/hide views
      dashboardView.classList.toggle('d-none', view !== 'dashboard');
      practiceView.classList.toggle('d-none', view !== 'practice');
      topicFocusView.classList.toggle('d-none', view !== 'topic-focus');
      
      // Update data for the view
      if (view === 'dashboard') {
        updateDashboardStats();
      } else if (view === 'topic-focus') {
        updateTopicStats();
      }
    }
    
    // Initialize by loading questions and starting the app
    loadQuestions();
  </script>
</body>
</html>
