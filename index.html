<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medical MCQ Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
      padding-bottom: 2rem;
    }
    .navbar {
      margin-bottom: 2rem;
    }
    .quiz-card {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .quiz-option {
      padding: 1rem;
      margin-bottom: 0.75rem;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .quiz-option:hover {
      background-color: #f8f9fa;
    }
    .quiz-option.selected {
      background-color: #e9ecef;
      border-color: #ced4da;
    }
    .quiz-option.correct {
      background-color: #d1e7dd;
      border-color: #badbcc;
    }
    .quiz-option.incorrect {
      background-color: #f8d7da;
      border-color: #f5c2c7;
    }
    .module-filter-btn.active {
      filter: brightness(85%);
    }
    .card-body {
      padding: 1.5rem;
    }
    .stat-number {
      font-size: 1.25rem;
      font-weight: 600;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }
    .question-progress-indicator {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }
    .module-stats {
      font-size: 0.85rem;
    }
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">Medical MCQ Quiz</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" id="dashboard-link" href="#"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="practice-link" href="#"><i class="bi bi-journals me-1"></i>Practice</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="modules-link" href="#"><i class="bi bi-grid-3x3-gap me-1"></i>Modules</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container" id="app-container">
    <!-- Dashboard View -->
    <div id="dashboard-view" class="view">
      <div class="row mb-4" id="dashboard-stats-row">
        <div class="col-md-6">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-bar-chart-line me-2"></i>Overall Performance</h5>
              <div class="d-flex justify-content-between mb-3">
                <div>
                  <h6 class="text-muted mb-1">Attempted</h6>
                  <h3 id="total-attempted">0</h3>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Correct</h6>
                  <h3 id="total-correct">0</h3>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Accuracy</h6>
                  <h3 id="overall-accuracy">0%</h3>
                </div>
              </div>
              <div>
                <h6 class="text-muted mb-2">Progress</h6>
                <div class="progress" style="height: 8px;">
                  <div id="accuracy-progress" class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-activity me-2"></i>Current Session</h5>
              <div class="d-flex justify-content-between mb-3">
                <div>
                  <h6 class="text-muted mb-1">Attempted</h6>
                  <h3 id="session-attempted">0</h3>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Correct</h6>
                  <h3 id="session-correct">0</h3>
                </div>
                <div>
                  <h6 class="text-muted mb-1">Accuracy</h6>
                  <h3 id="session-accuracy">0%</h3>
                </div>
              </div>
              <div class="d-grid">
                <button id="start-practice-btn" class="btn btn-primary">Start New Practice Session</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mb-4">
        <div class="col-12">
          <div class="card quiz-card">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-stopwatch me-2"></i>Recent Activity</h5>
            </div>
            <div class="card-body">
              <div id="recent-activity" class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th scope="col">Date</th>
                      <th scope="col">Module</th>
                      <th scope="col">Question</th>
                      <th scope="col">Result</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="4" class="text-center">No recent activity</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Practice View -->
    <div id="practice-view" class="view d-none">
      <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <span id="current-module-badge" class="badge bg-primary">All</span>
            <span class="ms-2">Topic: <span id="current-topic">General</span></span>
          </h4>
          <div>
            <div class="btn-group" role="group">
              <button id="save-progress-btn" class="btn btn-outline-primary">
                <i class="bi bi-bookmark me-1"></i>Save Progress
              </button>
              <button id="return-dashboard-btn" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Dashboard
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mb-4">
        <div class="col-12">
          <div class="card quiz-card">
            <div class="card-body">
              <h5 id="question-text" class="card-title mb-4">Loading question...</h5>
              <div id="options-container" class="mb-4">
                <!-- Options will be populated dynamically -->
              </div>
              <div id="explanation-container" class="alert alert-success mb-4 d-none">
                <h6><i class="bi bi-lightbulb me-2"></i>Explanation</h6>
                <div id="explanation-text"></div>
                <div class="mt-2">
                  <strong>Slide Reference:</strong> <span id="slide-link"></span>
                </div>
              </div>
              <div class="d-flex justify-content-between">
                <button id="prev-question" class="btn btn-outline-secondary" disabled>
                  <i class="bi bi-chevron-left me-1"></i>Previous
                </button>
                <div>
                  <button id="skip-question" class="btn btn-outline-warning">
                    <i class="bi bi-skip-forward me-1"></i>Skip
                  </button>
                </div>
                <button id="next-question" class="btn btn-outline-primary" disabled>
                  Next<i class="bi bi-chevron-right ms-1"></i>
                </button>
              </div>
            </div>
            <div class="card-footer">
              <div class="d-flex justify-content-between align-items-center">
                <span id="question-counter">Question 1 of 1</span>
                <div class="progress flex-grow-1 mx-3" style="height: 8px;">
                  <div id="question-progress" class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                </div>
                <div>
                  <span id="session-stats">Correct: 0/0 (0%)</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modules View -->
    <div id="modules-view" class="view d-none">
      <div class="row mb-4">
        <div class="col-12">
          <h4 class="mb-3">Select a Module to Practice</h4>
        </div>
      </div>
      
      <!-- FOCS Module -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card quiz-card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">FOCS Modules</h5>
            </div>
            <div class="card-body row">
              <div class="col-md-3 mb-3">
                <button class="btn btn-outline-primary w-100 module-filter-btn" data-module="focs1" data-filter="all">FOCS1</button>
              </div>
              <div class="col-md-3 mb-3">
                <button class="btn btn-outline-primary w-100 module-filter-btn" data-module="focs2" data-filter="all">FOCS2</button>
              </div>
              <div class="col-md-3 mb-3">
                <button class="btn btn-outline-primary w-100 module-filter-btn" data-module="focs3" data-filter="all">FOCS3</button>
              </div>
              <div class="col-md-3 mb-3">
                <button class="btn btn-outline-primary w-100 module-filter-btn" data-module="focs4" data-filter="all">FOCS4</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- BCR Module -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card quiz-card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">BCR Modules</h5>
            </div>
            <div class="card-body row">
              <div class="col-md-3 mb-3">
                <button class="btn btn-outline-success w-100 module-filter-btn" data-module="bcr1" data-filter="all">BCR1</button>
              </div>
              <div class="col-md-3 mb-3">
                <button class="btn btn-outline-success w-100 module-filter-btn" data-module="bcr2" data-filter="all">BCR2</button>
              </div>
              <div class="col-md-3 mb-3">
                <button class="btn btn-outline-success w-100 module-filter-btn" data-module="bcr3" data-filter="all">BCR3</button>
              </div>
              <div class="col-md-3 mb-3">
                <button class="btn btn-outline-success w-100 module-filter-btn" data-module="bcr4" data-filter="all">BCR4</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- MSK Module -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card quiz-card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">MSK Modules</h5>
            </div>
            <div class="card-body row">
              <div class="col-md-6 mb-3">
                <button class="btn btn-outline-info w-100 module-filter-btn" data-module="msk1" data-filter="all">MSK1</button>
              </div>
              <div class="col-md-6 mb-3">
                <button class="btn btn-outline-info w-100 module-filter-btn" data-module="msk2" data-filter="all">MSK2</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Anatomy Module -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card quiz-card">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">Anatomy Module</h5>
            </div>
            <div class="card-body row">
              <div class="col-md-12">
                <button class="btn btn-outline-warning w-100 module-filter-btn" data-module="anatomy" data-filter="all">ANATOMY</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- All Modules Option -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card quiz-card">
            <div class="card-header bg-dark text-white">
              <h5 class="mb-0">All Modules Combined</h5>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-9">
                  <div class="mb-3">
                    <h6>Filter by Question Status:</h6>
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-outline-primary module-filter-btn" data-module="all" data-filter="all">All Questions</button>
                      <button type="button" class="btn btn-outline-success module-filter-btn" data-module="all" data-filter="correct">Correct</button>
                      <button type="button" class="btn btn-outline-danger module-filter-btn" data-module="all" data-filter="incorrect">Incorrect</button>
                      <button type="button" class="btn btn-outline-secondary module-filter-btn" data-module="all" data-filter="unattempted">Unseen</button>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 text-end">
                  <div class="module-stats" id="all-stats">
                    <div><strong>Total:</strong> <span id="all-total">0</span></div>
                    <div><strong>Completed:</strong> <span id="all-completed">0</span></div>
                    <div><strong>Accuracy:</strong> <span id="all-accuracy">0%</span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalTitle">Confirmation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">
          Are you sure you want to proceed?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmModalAction">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load data files - trying all data files -->
  
  <script src="bcr-data3.js"></script>
  <script src="bcr-data4.js"></script>
  <script src="bcr-data1.js"></script>
  <script src="bcr-data2.js"></script>
  <script src="focs-data.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>

    
    // Initialize with empty arrays for questions
    const allQuestions = [];
    const focs1Questions = [];
    const focs2Questions = [];
    const focs3Questions = [];
    const focs4Questions = [];
    const bcr1Questions = [];
    const bcr2Questions = [];
    const bcr3Questions = [];
    const bcr4Questions = [];
    const msk1Questions = [];
    const msk2Questions = [];
    const anatomyQuestions = [];
    
    // App State
    let questions = [];
    let currentQuestionIndex = 0;
    let selectedAnswer = null;
    let answerSubmitted = false;
    let userHistory = [];
    let currentSessionStats = {
      attempted: 0,
      correct: 0
    };
    let currentView = 'dashboard';
    let currentModule = 'all';
    
    // DOM Elements
    const dashboardLink = document.getElementById('dashboard-link');
    const practiceLink = document.getElementById('practice-link');
    const modulesLink = document.getElementById('modules-link');
    const dashboardView = document.getElementById('dashboard-view');
    const practiceView = document.getElementById('practice-view');
    const modulesView = document.getElementById('modules-view');
    const questionCounter = document.getElementById('question-counter');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const explanationContainer = document.getElementById('explanation-container');
    const explanationText = document.getElementById('explanation-text');
    const slideLink = document.getElementById('slide-link');
    const prevQuestion = document.getElementById('prev-question');
    const nextQuestion = document.getElementById('next-question');
    const skipQuestion = document.getElementById('skip-question');
    const questionProgress = document.getElementById('question-progress');
    const sessionAttempted = document.getElementById('session-attempted');
    const sessionCorrect = document.getElementById('session-correct');
    const sessionAccuracy = document.getElementById('session-accuracy');
    const currentTopic = document.getElementById('current-topic');
    const currentModuleBadge = document.getElementById('current-module-badge');
    const totalAttempted = document.getElementById('total-attempted');
    const totalCorrect = document.getElementById('total-correct');
    const overallAccuracy = document.getElementById('overall-accuracy');
    const accuracyProgress = document.getElementById('accuracy-progress');
    const recentActivity = document.getElementById('recent-activity');
    const startPracticeBtn = document.getElementById('start-practice-btn');
    const returnDashboardBtn = document.getElementById('return-dashboard-btn');
    const saveProgressBtn = document.getElementById('save-progress-btn');
    
    // Module questions storage
    let moduleQuestions = {
      all: allQuestions,
      focs1: focs1Questions,
      focs2: focs2Questions,
      focs3: focs3Questions,
      focs4: focs4Questions,
      bcr1: bcr1Questions,
      bcr2: bcr2Questions,
      bcr3: bcr3Questions,
      bcr4: bcr4Questions,
      msk1: msk1Questions,
      msk2: msk2Questions,
      anatomy: anatomyQuestions
    };
    
   
    
    // Function to reload questions in case data files load asynchronously
    function reloadQuestions() {
      allQuestions.length = 0; // Clear existing questions
      
      // Repopulate from all sources
      allQuestions.push(
        ...focs1Questions, ...focs2Questions, ...focs3Questions, ...focs4Questions,
        ...bcr1Questions, ...bcr2Questions, ...bcr3Questions, ...bcr4Questions,
        ...msk1Questions, ...msk2Questions, ...anatomyQuestions
      );
      
      // If we're viewing all questions, update the current list
      if (currentModule === 'all') {
        questions = [...allQuestions];
        loadQuestion();
      }
      
      // Update stats
      updateDashboardStats();
    }
    
    // Load questions from data files
    function loadQuestions() {
      try {
        // Use the imported data
        if (typeof focsData !== 'undefined') {
          focs1Questions.push(...focsData);
        }
        
        if (typeof bcrData1 !== 'undefined') {
          bcr1Questions.push(...bcrData1);
        }
        
        if (typeof bcrData2 !== 'undefined') {
          bcr2Questions.push(...bcrData2);
        }
        
        // Try to use bcr3 and bcr4 data if they loaded properly
        if (typeof bcrData3 !== 'undefined') {
          bcr3Questions.push(...bcrData3);
        }
        
        if (typeof bcrData4 !== 'undefined') {
          bcr4Questions.push(...bcrData4);
        }
        
        // Add sample questions for other modules
        msk1Questions.push({
          question: "What enzyme is deficient in McArdle disease?",
          options: [
            "A) Glucose-6-phosphatase",
            "B) Myophosphorylase",
            "C) Glycogen synthase",
            "D) Acid maltase"
          ],
          correctIndex: 1,
          explanations: [
            "Incorrect: Glucose-6-phosphatase deficiency causes von Gierke disease.",
            "Correct: Myophosphorylase deficiency is the hallmark of McArdle disease.",
            "Incorrect: Glycogen synthase catalyzes glycogen formation, not breakdown.",
            "Incorrect: Acid maltase deficiency causes Pompe disease."
          ],
          slideLink: "Metabolism - Slide 9",
          topic: "Glycogen Storage Diseases"
        });
        
        msk2Questions.push({
          question: "Which joint is most commonly affected in osteoarthritis?",
          options: [
            "A) Elbow",
            "B) Knee",
            "C) Ankle",
            "D) Wrist"
          ],
          correctIndex: 1,
          explanations: [
            "Incorrect: Elbow involvement is rare in OA.",
            "Correct: The knee is the most commonly affected joint.",
            "Incorrect: Ankle OA is usually post-traumatic.",
            "Incorrect: Wrist OA is less common than knee or hip."
          ],
          slideLink: "Rheumatology - Slide 3",
          topic: "Osteoarthritis"
        });
        
        anatomyQuestions.push({
          question: "Which muscle is innervated by the thoracodorsal nerve?",
          options: [
            "A) Trapezius",
            "B) Rhomboid major",
            "C) Latissimus dorsi",
            "D) Levator scapulae"
          ],
          correctIndex: 2,
          explanations: [
            "Incorrect: Trapezius is innervated by the spinal accessory nerve.",
            "Incorrect: Rhomboids are innervated by the dorsal scapular nerve.",
            "Correct: Thoracodorsal nerve innervates the latissimus dorsi.",
            "Incorrect: Levator scapulae is also innervated by the dorsal scapular nerve."
          ],
          slideLink: "Upper Limb - Slide 5",
          topic: "Shoulder Muscles"
        });
        
        // Combine all questions
        allQuestions.push(
          ...focs1Questions, ...focs2Questions, ...focs3Questions, ...focs4Questions,
          ...bcr1Questions, ...bcr2Questions, ...bcr3Questions, ...bcr4Questions,
          ...msk1Questions, ...msk2Questions, ...anatomyQuestions
        );
        
        // Set initial questions to all questions
        questions = [...allQuestions];
        
    
    // Event listeners
    function setupEventListeners() {
      // Navigation
      dashboardLink.addEventListener('click', function(e) {
        e.preventDefault();
        switchView('dashboard');
      });
      
      practiceLink.addEventListener('click', function(e) {
        e.preventDefault();
        switchView('practice');
      });
      
      modulesLink.addEventListener('click', function(e) {
        e.preventDefault();
        switchView('modules');
      });
      
      // Start practice button
      startPracticeBtn.addEventListener('click', function() {
        currentModule = 'all';
        questions = [...allQuestions];
        currentQuestionIndex = 0;
        loadQuestion();
        switchView('practice');
      });
      
      // Return to dashboard button
      returnDashboardBtn.addEventListener('click', function() {
        switchView('dashboard');
      });
      
      // Module filter buttons
      document.querySelectorAll('.module-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const module = this.getAttribute('data-module');
          const filter = this.getAttribute('data-filter');
          
          // Set current module
          currentModule = module;
          
          // Update UI
          currentModuleBadge.textContent = module.toUpperCase();
          
          // Load questions for this module
          if (moduleQuestions[module]) {
            questions = [...moduleQuestions[module]];
          } else {
            questions = [...allQuestions];
          }
          
          // Reset question index
          currentQuestionIndex = 0;
          
          // Load the first question
          loadQuestion();
          
          // Switch to practice view
          switchView('practice');
        });
      });
      
      // Question navigation buttons
      prevQuestion.addEventListener('click', function() {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          loadQuestion();
        }
      });
      
      nextQuestion.addEventListener('click', function() {
        if (currentQuestionIndex < questions.length - 1) {
          currentQuestionIndex++;
          loadQuestion();
        }
      });
      
      skipQuestion.addEventListener('click', function() {
        if (currentQuestionIndex < questions.length - 1) {
          currentQuestionIndex++;
          loadQuestion();
        }
      });
    }
    
    // Switch between views
    function switchView(view) {
      // Hide all views
      dashboardView.classList.add('d-none');
      practiceView.classList.add('d-none');
      modulesView.classList.add('d-none');
      
      // Remove active class from all links
      dashboardLink.classList.remove('active');
      practiceLink.classList.remove('active');
      modulesLink.classList.remove('active');
      
      // Show the selected view
      if (view === 'dashboard') {
        dashboardView.classList.remove('d-none');
        dashboardLink.classList.add('active');
        updateDashboardStats();
      } else if (view === 'practice') {
        practiceView.classList.remove('d-none');
        practiceLink.classList.add('active');
      } else if (view === 'modules') {
        modulesView.classList.remove('d-none');
        modulesLink.classList.add('active');
      }
      
      // Update current view
      currentView = view;
    }
    
    // Load the current question
    function loadQuestion() {
      if (questions.length === 0) {
        questionText.textContent = "No questions available.";
        optionsContainer.innerHTML = "";
        return;
      }
      
      const question = questions[currentQuestionIndex];
      questionText.textContent = question.question;
      questionCounter.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
      
      if (question.topic) {
        currentTopic.textContent = question.topic;
      } else {
        currentTopic.textContent = "General";
      }
      
      // Update progress bar
      const progressPercent = ((currentQuestionIndex + 1) / questions.length) * 100;
      questionProgress.style.width = `${progressPercent}%`;
      
      // Clear previous options and explanation
      optionsContainer.innerHTML = "";
      explanationContainer.classList.add('d-none');
      
      // Populate options
      question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'quiz-option';
        optionDiv.textContent = option;
        optionDiv.dataset.index = index;
        
        // Check if this question has been answered before
        const historyItem = userHistory.find(item => 
          item.questionText === question.question
        );
        
        if (historyItem) {
          if (historyItem.selectedAnswer === index) {
            optionDiv.classList.add('selected');
            if (index === question.correctIndex) {
              optionDiv.classList.add('correct');
            } else {
              optionDiv.classList.add('incorrect');
            }
          } else if (index === question.correctIndex) {
            optionDiv.classList.add('correct');
          }
          answerSubmitted = true;
          explanationContainer.classList.remove('d-none');
          populateExplanation(question);
        } else {
          answerSubmitted = false;
          optionDiv.addEventListener('click', function() {
            selectOption(index);
          });
        }
        
        optionsContainer.appendChild(optionDiv);
      });
      
      // Update navigation buttons
      prevQuestion.disabled = currentQuestionIndex === 0;
      nextQuestion.disabled = !answerSubmitted;
    }
    
    // Select an option
    function selectOption(index) {
      if (answerSubmitted) return;
      
      const question = questions[currentQuestionIndex];
      const isCorrect = index === question.correctIndex;
      
      // Mark the selected option
      const options = optionsContainer.querySelectorAll('.quiz-option');
      options.forEach(option => {
        const optionIndex = parseInt(option.dataset.index);
        option.classList.remove('selected', 'correct', 'incorrect');
        
        if (optionIndex === index) {
          option.classList.add('selected');
          if (isCorrect) {
            option.classList.add('correct');
          } else {
            option.classList.add('incorrect');
          }
        } else if (optionIndex === question.correctIndex) {
          option.classList.add('correct');
        }
      });
      
      // Show explanation
      explanationContainer.classList.remove('d-none');
      populateExplanation(question);
      
      // Record answer
      const historyItem = {
        questionText: question.question,
        selectedAnswer: index,
        isCorrect: isCorrect,
        timestamp: new Date().toISOString(),
        module: currentModule
      };
      
      const existingIndex = userHistory.findIndex(item => item.questionText === question.question);
      if (existingIndex !== -1) {
        userHistory[existingIndex] = historyItem;
      } else {
        userHistory.push(historyItem);
      }
      
      // Save to local storage
      localStorage.setItem('userHistory', JSON.stringify(userHistory));
      
      // Update stats
      currentSessionStats.attempted++;
      if (isCorrect) currentSessionStats.correct++;
      updateSessionStats();
      
      // Enable next button
      nextQuestion.disabled = false;
      answerSubmitted = true;
    }
    
    // Populate explanation
    function populateExplanation(question) {
      explanationText.innerHTML = '';
      
      if (question.explanations) {
        question.explanations.forEach((exp, index) => {
          const expPara = document.createElement('p');
          expPara.className = 'mb-1';
          if (exp.includes('Correct:')) {
            expPara.className += ' text-success fw-bold';
          }
          expPara.textContent = exp;
          explanationText.appendChild(expPara);
        });
      } else {
        explanationText.textContent = 'No explanation available.';
      }
      
      if (question.slideLink) {
        slideLink.textContent = question.slideLink;
      } else {
        slideLink.textContent = 'No slide reference';
      }
    }
    
    // Update session stats
    function updateSessionStats() {
      sessionAttempted.textContent = currentSessionStats.attempted;
      sessionCorrect.textContent = currentSessionStats.correct;
      
      const accuracy = currentSessionStats.attempted > 0 
        ? Math.round((currentSessionStats.correct / currentSessionStats.attempted) * 100) 
        : 0;
      
      sessionAccuracy.textContent = `${accuracy}%`;
      
      // Update the session stats display
      document.getElementById('session-stats').textContent = `Correct: ${currentSessionStats.correct}/${currentSessionStats.attempted} (${accuracy}%)`;
    }
    
    // Update dashboard stats
    function updateDashboardStats() {
      // Calculate overall stats
      const totalQuestions = allQuestions.length;
      const attemptedQuestions = userHistory.length;
      const correctQuestions = userHistory.filter(item => item.isCorrect).length;
      
      const accuracy = attemptedQuestions > 0
        ? Math.round((correctQuestions / attemptedQuestions) * 100)
        : 0;
      
      // Update UI
      totalAttempted.textContent = attemptedQuestions;
      totalCorrect.textContent = correctQuestions;
      overallAccuracy.textContent = `${accuracy}%`;
      
      // Update progress bar
      accuracyProgress.style.width = `${accuracy}%`;
      accuracyProgress.setAttribute('aria-valuenow', accuracy);
      
      // Update recent activity
      updateRecentActivity();
    }
    
    // Update recent activity in dashboard
    function updateRecentActivity() {
      const activityTable = recentActivity.querySelector('tbody');
      activityTable.innerHTML = '';
      
      // Sort history by timestamp (most recent first)
      const sortedHistory = [...userHistory].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );
      
      // Take the 5 most recent items
      const recentItems = sortedHistory.slice(0, 5);
      
      if (recentItems.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" class="text-center">No recent activity</td>';
        activityTable.appendChild(row);
      } else {
        recentItems.forEach(item => {
          const row = document.createElement('tr');
          
          // Format date
          const date = new Date(item.timestamp);
          const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
          
          // Create cells
          row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${item.module.toUpperCase()}</td>
            <td>${item.questionText.substring(0, 30)}${item.questionText.length > 30 ? '...' : ''}</td>
            <td><span class="badge ${item.isCorrect ? 'bg-success' : 'bg-danger'}">${item.isCorrect ? 'Correct' : 'Incorrect'}</span></td>
          `;
          
          activityTable.appendChild(row);
        });
      }
    }
    
    // Load user history from local storage
    function loadUserHistory() {
      const savedHistory = localStorage.getItem('userHistory');
      if (savedHistory) {
        userHistory = JSON.parse(savedHistory);
      }
    }
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      loadUserHistory();
      loadQuestions();
      setupEventListeners();
      loadQuestion();
      updateSessionStats();
      updateDashboardStats();
    });
  </script>
</body>
</html>
